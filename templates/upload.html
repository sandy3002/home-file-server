{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="mb-4"><i class="bi bi-upload"></i> Upload Files</h1>

    <div class="card">
      <div class="card-body">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="uploadPath" class="form-label">
              <i class="bi bi-folder"></i> Upload to folder (optional)
            </label>
            <input
              type="text"
              class="form-control"
              id="uploadPath"
              name="upload_path"
              placeholder="Leave empty for root folder or enter path like 'videos/movies'"
            />
          </div>

          <div class="upload-zone" id="uploadZone">
            <div class="upload-content">
              <i class="bi bi-cloud-upload fs-1 text-muted"></i>
              <h4 class="mt-3">Drop files here or click to browse</h4>
              <p class="text-muted mb-3">
                Supported formats: Images, Videos, Audio, Documents, Archives
              </p>
              <input
                type="file"
                id="fileInput"
                name="files[]"
                multiple
                style="display: none"
              />
              <button
                type="button"
                class="btn btn-primary"
                onclick="document.getElementById('fileInput').click()"
              >
                <i class="bi bi-folder2-open"></i> Choose Files
              </button>
            </div>
          </div>

          <div id="fileList" class="mt-4" style="display: none">
            <h5>Selected Files:</h5>
            <div id="selectedFiles" class="list-group">
              <!-- Selected files will appear here -->
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button
              type="submit"
              class="btn btn-success"
              id="uploadBtn"
              disabled
            >
              <i class="bi bi-upload"></i> Upload Files
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="clearFiles()"
            >
              <i class="bi bi-x-circle"></i> Clear
            </button>
            <a
              href="{{ url_for('browse_files') }}"
              class="btn btn-outline-primary"
            >
              <i class="bi bi-folder"></i> Browse Files
            </a>
          </div>
        </form>

        <!-- Upload Progress -->
        <div id="uploadProgress" class="mt-4" style="display: none">
          <h5>Upload Progress</h5>
          <div class="progress mb-3">
            <div
              class="progress-bar"
              id="progressBar"
              role="progressbar"
              style="width: 0%"
            ></div>
          </div>
          <div id="uploadStatus"></div>
        </div>

        <!-- Upload Results -->
        <div id="uploadResults" class="mt-4" style="display: none">
          <h5>Upload Results</h5>
          <div id="resultsContent"></div>
        </div>
      </div>
    </div>

    <!-- Upload Tips -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-lightbulb"></i> Upload Tips
            </h5>
            <ul class="list-unstyled mb-0">
              <li>
                <i class="bi bi-check-circle text-success"></i> Drag and drop
                multiple files at once
              </li>
              <li>
                <i class="bi bi-check-circle text-success"></i> Create folders
                using the path field (e.g., "movies/action")
              </li>
              <li>
                <i class="bi bi-check-circle text-success"></i> Maximum file
                size: 1GB per file
              </li>
              <li>
                <i class="bi bi-check-circle text-success"></i> Videos and audio
                will be streamable after upload
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-file-earmark-check"></i> Supported Formats
            </h5>
            <div class="row">
              <div class="col-6">
                <small class="text-muted d-block"
                  ><strong>Video:</strong></small
                >
                <small>MP4, AVI, MKV</small>
                <small class="text-muted d-block mt-2"
                  ><strong>Audio:</strong></small
                >
                <small>MP3, WAV, FLAC</small>
              </div>
              <div class="col-6">
                <small class="text-muted d-block"
                  ><strong>Images:</strong></small
                >
                <small>JPG, PNG, GIF</small>
                <small class="text-muted d-block mt-2"
                  ><strong>Documents:</strong></small
                >
                <small>TXT, PDF</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let selectedFiles = [];

  // File input change event
  document.getElementById("fileInput").addEventListener("change", function (e) {
    handleFiles(Array.from(e.target.files));
  });

  // Drag and drop functionality
  const uploadZone = document.getElementById("uploadZone");

  uploadZone.addEventListener("dragover", function (e) {
    e.preventDefault();
    uploadZone.classList.add("dragover");
  });

  uploadZone.addEventListener("dragleave", function (e) {
    e.preventDefault();
    uploadZone.classList.remove("dragover");
  });

  uploadZone.addEventListener("drop", function (e) {
    e.preventDefault();
    uploadZone.classList.remove("dragover");
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  });

  // Click to open file dialog
  uploadZone.addEventListener("click", function (e) {
    if (e.target === uploadZone || e.target.closest(".upload-content")) {
      document.getElementById("fileInput").click();
    }
  });

  function handleFiles(files) {
    selectedFiles = [...selectedFiles, ...files];
    updateFileList();
    updateUploadButton();
  }

  function updateFileList() {
    const fileListDiv = document.getElementById("fileList");
    const selectedFilesDiv = document.getElementById("selectedFiles");

    if (selectedFiles.length === 0) {
      fileListDiv.style.display = "none";
      return;
    }

    fileListDiv.style.display = "block";
    selectedFilesDiv.innerHTML = "";

    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement("div");
      fileItem.className =
        "list-group-item d-flex justify-content-between align-items-center";

      const fileInfo = document.createElement("div");
      fileInfo.innerHTML = `
            <i class="bi bi-file-earmark me-2"></i>
            <strong>${file.name}</strong>
            <small class="text-muted ms-2">(${formatFileSize(
              file.size
            )})</small>
        `;

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btn-sm btn-outline-danger";
      removeBtn.innerHTML = '<i class="bi bi-x"></i>';
      removeBtn.onclick = () => removeFile(index);

      fileItem.appendChild(fileInfo);
      fileItem.appendChild(removeBtn);
      selectedFilesDiv.appendChild(fileItem);
    });
  }

  function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
    updateUploadButton();
  }

  function clearFiles() {
    selectedFiles = [];
    document.getElementById("fileInput").value = "";
    updateFileList();
    updateUploadButton();
    hideResults();
  }

  function updateUploadButton() {
    const uploadBtn = document.getElementById("uploadBtn");
    uploadBtn.disabled = selectedFiles.length === 0;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  // Form submission
  document
    .getElementById("uploadForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      if (selectedFiles.length === 0) {
        alert("Please select files to upload");
        return;
      }

      const formData = new FormData();
      const uploadPath = document.getElementById("uploadPath").value.trim();

      selectedFiles.forEach((file) => {
        formData.append("files[]", file);
      });
      formData.append("upload_path", uploadPath);

      uploadFiles(formData);
    });

  function uploadFiles(formData) {
    const progressDiv = document.getElementById("uploadProgress");
    const progressBar = document.getElementById("progressBar");
    const statusDiv = document.getElementById("uploadStatus");
    const uploadBtn = document.getElementById("uploadBtn");

    // Show progress
    progressDiv.style.display = "block";
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';

    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener("progress", function (e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + "%";
        progressBar.textContent = Math.round(percentComplete) + "%";
        statusDiv.textContent = `Uploading... ${Math.round(percentComplete)}%`;
      }
    });

    xhr.addEventListener("load", function () {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        showResults(response.results);
      } else {
        statusDiv.textContent = "Upload failed";
        statusDiv.className = "text-danger";
      }

      uploadBtn.disabled = false;
      uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload Files';
    });

    xhr.addEventListener("error", function () {
      statusDiv.textContent = "Upload failed - Network error";
      statusDiv.className = "text-danger";
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload Files';
    });

    xhr.open("POST", "/upload");
    xhr.send(formData);
  }

  function showResults(results) {
    const resultsDiv = document.getElementById("uploadResults");
    const resultsContent = document.getElementById("resultsContent");

    resultsDiv.style.display = "block";
    resultsContent.innerHTML = "";

    results.forEach((result) => {
      const resultItem = document.createElement("div");
      resultItem.className = `alert ${
        result.success ? "alert-success" : "alert-danger"
      }`;

      const icon = result.success ? "bi-check-circle" : "bi-x-circle";
      const message = result.success
        ? `Successfully uploaded: ${result.filename}`
        : `Failed to upload ${result.filename}: ${result.error}`;

      resultItem.innerHTML = `<i class="bi ${icon}"></i> ${message}`;
      resultsContent.appendChild(resultItem);
    });

    // Clear selected files if all uploads were successful
    const allSuccessful = results.every((r) => r.success);
    if (allSuccessful) {
      setTimeout(() => {
        clearFiles();
      }, 2000);
    }
  }

  function hideResults() {
    document.getElementById("uploadProgress").style.display = "none";
    document.getElementById("uploadResults").style.display = "none";
  }
</script>
{% endblock %}
